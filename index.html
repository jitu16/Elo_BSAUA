<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELO Soccer Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, setDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        window.firebase = {
            initializeApp, getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged,
            getFirestore, collection, onSnapshot, query, setDoc, doc, updateDoc, deleteDoc
        };
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // --- CONFIGURATION ---
        
        // 1. ADMIN EMAILS (Case Insensitive in logic below)
        const ADMIN_EMAILS = [
            "jitumstock@gmail.com" 
        ];

        const ELO_FIREBASE_CONFIG_JSON = {
              apiKey: "AIzaSyAD6e_Qw0Lcjo0D_tzSuC4C44nFRh23OGM",
              authDomain: "elobsaua.firebaseapp.com",
              projectId: "elobsaua",
              storageBucket: "elobsaua.firebasestorage.app",
              messagingSenderId: "1084434478120",
              appId: "1:1084434478120:web:f63b1578390161603f311d",
              measurementId: "G-JWBLS97QFY"
        };
        
        const appId = "soccer-tracker-prod";
        const firebaseConfig = ELO_FIREBASE_CONFIG_JSON; 
        
        const INITIAL_ELO = 1500;
        const K_INITIAL = 40; 
        const K_STABLE = 20; 
        const MATCH_CUTOFF = 10;

        // --- Helper Functions ---
        const calculateExpectedScore = (teamAElo, teamBElo) => {
            const ratingDiff = teamAElo - teamBElo;
            return 1 / (1 + Math.pow(10, -ratingDiff / 400));
        };

        const getKFactor = (matchesPlayed) => {
            return matchesPlayed < MATCH_CUTOFF ? K_INITIAL : K_STABLE;
        };

        const getMarginMultiplier = (goalDifference) => {
            if (goalDifference === 0) return 1;
            if (goalDifference === 1) return 1;
            if (goalDifference === 2) return 1.5;
            if (goalDifference === 3) return 2;
            return 2.5;
        };

        function App() {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [user, setUser] = useState(null); 
            const [players, setPlayers] = useState([]);
            const [activeTab, setActiveTab] = useState('leaderboard');
            const [isAddingPlayer, setIsAddingPlayer] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            const isAdmin = useMemo(() => {
                if (!user || !user.email) return false;
                return ADMIN_EMAILS.some(adminEmail => 
                    adminEmail.trim().toLowerCase() === user.email.trim().toLowerCase()
                );
            }, [user]);

            useEffect(() => {
                if (!window.firebase) {
                    setError("Firebase SDK not loaded.");
                    setIsLoading(false);
                    return;
                }
                
                try {
                    const app = window.firebase.initializeApp(firebaseConfig);
                    const firestore = window.firebase.getFirestore(app);
                    const authInstance = window.firebase.getAuth(app);
                    setDb(firestore);
                    setAuth(authInstance);

                    window.firebase.onAuthStateChanged(authInstance, async (currentUser) => {
                        setUser(currentUser); 
                        setIsLoading(false);
                    });
                } catch (e) {
                    console.error("Init Error:", e);
                    setError("Failed to initialize Firebase.");
                    setIsLoading(false);
                }
            }, []);

            const handleGoogleLogin = async () => {
                try {
                    const provider = new window.firebase.GoogleAuthProvider();
                    await window.firebase.signInWithPopup(auth, provider);
                } catch (e) {
                    alert("Login failed: " + e.message);
                }
            };

            const handleLogout = async () => {
                try {
                    await window.firebase.signOut(auth);
                    setActiveTab('leaderboard');
                } catch (e) { console.error(e); }
            };

            useEffect(() => {
                if (!db) return;
                const playersCollectionRef = window.firebase.collection(db, `artifacts/${appId}/public/data/players`);
                const q = window.firebase.query(playersCollectionRef);

                const unsubscribe = window.firebase.onSnapshot(q, (snapshot) => {
                    const playerList = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        elo: Number(doc.data().elo) || INITIAL_ELO,
                        matchesPlayed: Number(doc.data().matchesPlayed) || 0,
                    }));
                    setPlayers(playerList);
                    setError(null);
                }, (e) => {
                    if (e.code === 'permission-denied') {
                        setError("Database Permission Denied. Check Firestore Rules.");
                    } else {
                        setError("Failed to load data.");
                    }
                });
                return () => unsubscribe();
            }, [db]);

            const sortedPlayers = useMemo(() => [...players].sort((a, b) => b.elo - a.elo), [players]);

            const handleAddPlayer = async (name, customElo, customMatches) => {
                if (!db || !isAdmin) return; 
                const newPlayer = {
                    name: name.trim(),
                    elo: Number(customElo),
                    matchesPlayed: Number(customMatches),
                    updatedBy: user.email, 
                    createdAt: new Date().toISOString(),
                };
                
                try {
                    const newPlayerRef = window.firebase.doc(window.firebase.collection(db, `artifacts/${appId}/public/data/players`));
                    await window.firebase.setDoc(newPlayerRef, newPlayer);
                    setIsAddingPlayer(false);
                } catch (e) { alert("Error adding player: " + e.message); }
            };

            const handleDeletePlayer = async (playerId, playerName) => {
                if (!db || !isAdmin) return;
                if (!confirm(`Are you sure you want to PERMANENTLY delete ${playerName}? This cannot be undone.`)) return;
                try {
                    await window